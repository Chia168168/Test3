<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teng Image Tools v1.5</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#0b1020; color:#e7ecf3; }
h1, h2 { text-align: center; }
.tabs { display: flex; justify-content: center; margin-bottom: 20px; gap:10px; flex-wrap:wrap; }
.tab { padding: 10px 20px; cursor: pointer; border-radius:6px; background:#002366; color:#fff; font-weight:bold; }
.tab.active { background:#0044aa; }
.tab-content { display: none; }
.tab-content.active { display: block; }
textarea { width: 100%; height: 150px; }
img.preview { max-width: 100%; max-height: 200px; display: block; margin: 10px auto; }
button { margin: 10px 0; padding:10px; font-size:16px; cursor:pointer; }
select, input[type="number"], input[type="text"], input[type="range"] {
  padding:10px; border-radius:6px; border:1px solid #27314a; background:#141a2e; color:#e7ecf3; font-size:16px; width:100%;
  box-sizing:border-box;
}
.card{background:#141a2e;border:1px solid #27314a;border-radius:12px;padding:16px;margin:12px auto;max-width:100%}
.log{font-family:monospace;background:#0a0f22;border:1px solid #27314a;border-radius:8px;padding:10px;height:160px;overflow:auto}
.thumbs{display:grid;grid-template-columns:repeat(4,1fr); gap:12px;}
.thumb{background:#0c1226;border:1px solid #27314a;border-radius:12px;overflow:hidden}
.thumb img{width:100%;display:block}
.thumb .meta{padding:8px;font-size:12px;color:#9aa4b2;text-align:center}
.drop{border:2px dashed #2b3b66;border-radius:10px;padding:18px;text-align:center;color:#c7d2fe;background:#0d1330;margin-bottom:10px}
.drop.dragover{outline:2px solid #5eead4}
label{display:block;margin-top:10px;font-size:14px;color:#9aa4b2}
.file-btn { display:inline-block; padding:10px 20px; background:#002366; color:#fff; border-radius:6px; cursor:pointer; margin:5px 0; text-align:center; }
.file-btn input[type=file]{ display:none; }

.options-section { margin-top:15px; }
.option-group { margin-top:10px; }

.format-buttons { display:flex; gap:10px; margin-top:5px; }
.format-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; background:#007bff; color:white; font-weight:bold; }
.format-btn.active { background:#0056b3; }

@media(max-width:600px){
  .thumbs{grid-template-columns:repeat(2,1fr);}
  body { margin:5px; }
  .card { margin:5px; padding:12px; }
  button, select, input, textarea { width:100% !important; box-sizing:border-box; font-size:16px; }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/pica@8.0.0/dist/pica.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
</head>
<body>
<h1>Teng Image Tools v1.5</h1>

<div class="tabs">
  <div class="tab active" data-tab="resizer">尺寸格式調整</div>
  <div class="tab" data-tab="base64">Base64轉換</div>
</div>

<div id="resizer" class="tab-content active">
  <section class="card">
    <h2>圖片尺寸/格式調整器</h2>
    <div class="drop" id="drop">拖曳圖片或資料夾到這裡</div>
    <label class="file-btn">選擇檔案
      <input id="fileFiles" type="file" accept="image/*,.heic,.heif" multiple>
    </label>
    <label class="file-btn">選擇資料夾
      <input id="fileFolder" type="file" webkitdirectory>
    </label>

    <h3>執行</h3>
    <button id="process">開始處理</button>
    <button id="clear">清空</button>

    <div class="options-section">
      <h3>輸出選項</h3>
      <!-- 格式 -->
      <div class="option-group">
        <label>輸出格式：</label>
        <div class="format-buttons">
          <button type="button" class="format-btn active" data-format="jpg">JPG</button>
          <button type="button" class="format-btn" data-format="png">PNG</button>
          <button type="button" class="format-btn" data-format="webp">WebP</button>
        </div>
      </div>
      <!-- JPG 品質 -->
      <div class="option-group" id="jpgQualityContainer">
        <label for="jpgQuality">JPG 品質：</label>
        <input type="number" id="jpgQuality" min="1" max="100" value="90"> %
      </div>
    </div>

    <label>長邊
      <select id="longSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input type="number" id="longSideCustom" placeholder="自訂長邊" style="display:none; margin-top:5px;">
    </label>
    <label>短邊
      <select id="shortSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input type="number" id="shortSideCustom" placeholder="自訂短邊" style="display:none; margin-top:5px;">
    </label>

    <label><input id="lock" type="checkbox" checked> 維持長寬比</label>
    <label>縮放比例 (%) <input id="scale" type="range" min="10" max="200" value="100"><span id="scaleLabel">100%</span></label>
    <div id="note" style="color:#ff7777; margin-top:5px;">注意：已設定長/短邊，縮放比例將忽略</div>

    <h3>預覽</h3>
    <div id="thumbs" class="thumbs"></div>
    <h3>日誌</h3>
    <div id="log" class="log"></div>
  </section>
</div>

<div id="base64" class="tab-content">
  <section class="card">
    <h2>圖片 → Base64</h2>
    <label class="file-btn">選擇檔案
      <input type="file" id="imgToBase64" accept="image/*">
    </label>
    <button id="downloadBase64Btn">下載 Base64 txt</button>
    <textarea id="base64Output" placeholder="這裡會顯示 Base64 編碼"></textarea>
    <img id="previewBase64Img" class="preview">

    <hr>
    <h2>Base64 → 圖片</h2>
    <textarea id="base64Input" placeholder="貼上 Base64 字串（或直接選檔）"></textarea>
    <label class="file-btn">選擇檔案
      <input type="file" id="base64File" accept=".txt">
    </label>
    <div id="progressContainer" style="width:100%; background:#ddd; height:10px; display:none; margin:10px 0;">
      <div id="progressBar" style="width:0%; height:100%; background:#4caf50; text-align:center; color:white; font-size:12px;">0%</div>
    </div>
    <a id="downloadRestored" style="display:none" download="restored.png">下載圖片</a>
    <img id="restoredImg" class="preview">
  </section>
</div>

<script>
const picaInstance = window.pica({features:['js','wasm','cib']});

// 分頁切換
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// 日誌
const logEl = document.getElementById("log");
function log(msg){ 
  const time=new Date().toLocaleTimeString(); 
  logEl.innerHTML+=`[${time}] ${msg}<br>`; 
  logEl.scrollTop=logEl.scrollHeight;
}

// 縮圖資料
const thumbs = document.getElementById("thumbs");
const queue = [];
const thumbList = [];

// 顯示/隱藏自訂欄
['longSide','shortSide'].forEach(id=>{
  document.getElementById(id).addEventListener('change', e=>{
    const custom = document.getElementById(id+'Custom');
    custom.style.display = e.target.value==-1 ? 'block':'none';
    updateThumbs();
  });
});
['longSideCustom','shortSideCustom'].forEach(id=>document.getElementById(id).addEventListener('input',updateThumbs));

// 縮放比例顯示
document.getElementById('scale').addEventListener('input', e=>{
  document.getElementById('scaleLabel').textContent = e.target.value + '%';
  updateThumbs();
});
document.getElementById('lock').addEventListener('change', updateThumbs);

// 輸出格式切換
document.querySelectorAll(".format-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".format-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const format = btn.getAttribute("data-format");
    document.getElementById("jpgQualityContainer").style.display = (format === "jpg") ? "block" : "none";
  });
});
document.getElementById("jpgQualityContainer").style.display = "block";

// 拖放/選檔
const drop=document.getElementById('drop');
drop.addEventListener('dragover', e=>{e.preventDefault(); drop.classList.add('dragover');});
drop.addEventListener('dragleave', e=>{e.preventDefault(); drop.classList.remove('dragover');});
drop.addEventListener('drop', e=>{e.preventDefault(); drop.classList.remove('dragover'); handleFiles([...e.dataTransfer.files]);});
document.getElementById('fileFiles').addEventListener('change', e=>handleFiles([...e.target.files]));
document.getElementById('fileFolder').addEventListener('change', e=>handleFiles([...e.target.files]));

async function handleFiles(list){
  for(const file of list){
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{
      const thumb = {file, url, origW: img.naturalWidth, origH: img.naturalHeight, w: img.naturalWidth, h: img.naturalHeight};
      queue.push(thumb);
      addThumb(thumb);
    };
    img.src = url;
  }
  log(`加入 ${list.length} 個檔案`);
}

// 新增縮圖
function addThumb(thumb){
  const div = document.createElement('div'); div.className='thumb';
  const imgEl = new Image(); imgEl.src = thumb.url; div.appendChild(imgEl);
  const meta = document.createElement('div'); meta.className='meta';
  meta.textContent = `${thumb.origW}×${thumb.origH} → ${thumb.w}×${thumb.h}`;
  div.appendChild(meta);
  thumb.div = div; thumb.meta = meta; thumb.imgEl = imgEl;
  thumbs.appendChild(div);
  thumbList.push(thumb);
}

// 計算目標尺寸
function calcTargetSize(origW,origH){
  let w=origW,h=origH;
  const longSel=Number(document.getElementById('longSide').value);
  const shortSel=Number(document.getElementById('shortSide').value);
  const longCustom=Number(document.getElementById('longSideCustom').value);
  const shortCustom=Number(document.getElementById('shortSideCustom').value);
  const scale=Number(document.getElementById('scale').value)/100;
  const lock=document.getElementById('lock').checked;

  if(longSel>0 || longSel==-1 || shortSel>0 || shortSel==-1){
    let targetLong = longSel>0 ? longSel : (longSel==-1 && longCustom>0 ? longCustom: origW);
    let targetShort = shortSel>0 ? shortSel : (shortSel==-1 && shortCustom>0 ? shortCustom: origH);
    if(origW>=origH){ w=targetLong; h=targetShort; if(lock) h=Math.round(origH*(w/origW)); }
    else{ h=targetLong; w=targetShort; if(lock) w=Math.round(origW*(h/origH)); }
  } else{
    w = Math.round(origW*scale); h=Math.round(origH*scale);
  }
  return {w,h};
}

// 更新所有縮圖尺寸顯示
function updateThumbs(){
  thumbList.forEach(t=>{
    const {w,h}=calcTargetSize(t.origW,t.origH);
    t.w=w; t.h=h;
    t.meta.textContent = `${t.origW}×${t.origH} → ${t.w}×${t.h}`;
  });
}

// 處理圖片
async function processFile(t){
  try{
    let f=t.file;
    if(f.name.toLowerCase().endsWith(".heic")||f.name.toLowerCase().endsWith(".heif")){
      const blob = await heic2any({blob:f,toType:"image/png"});
      f = new File([blob],f.name.replace(/\.(heic|heif)$/i,'.png'),{type:"image/png"});
    }
    const img = await new Promise(res=>{
      const i=new Image(); i.onload=()=>res(i); i.src=URL.createObjectURL(f);
    });
    const {w,h} = calcTargetSize(img.naturalWidth,img.naturalHeight);
    const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
    await picaInstance.resize(img,canvas,{quality:3,alpha:true});

    // 輸出格式與品質
    const formatBtn = document.querySelector(".format-btn.active");
    let mime = 'image/jpeg';
    if(formatBtn) mime = (formatBtn.getAttribute("data-format")==='jpg') ? 'image/jpeg' : 'image/'+formatBtn.getAttribute("data-format");
    let quality = (mime==='image/jpeg' || mime==='image/webp') ? Number(document.getElementById('jpgQuality').value)/100 : undefined;

    const outBlob=await picaInstance.toBlob(canvas,mime,quality);
    return {blob:outBlob,name:`${f.name.replace(/\.[^.]+$/,'')}_${w}x${h}.${mime.split('/')[1]}`};
  }catch(e){ log(`錯誤：${t.file.name} → ${e}`); return null;}
}

// 執行處理
document.getElementById('process').addEventListener('click', async()=>{
  if(queue.length===0){ log('尚未選擇檔案'); return;}
  log(`開始處理 ${queue.length} 個檔案…`);
  const results=[];
  for(const t of queue){ const r=await processFile(t); if(r) results.push(r);}
  if(results.length===1) downloadBlob(results[0].blob,results[0].name);
  else if(results.length>1){
    const zip=new JSZip(); results.forEach(r=>zip.file(r.name,r.blob));
    const content=await zip.generateAsync({type:'blob'}); saveAs(content,'images.zip');
    log('全部完成 ✅ (已打包 ZIP)');
  }
});

function downloadBlob(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000);}
document.getElementById('clear').addEventListener('click',()=>{queue.length=0; thumbs.innerHTML=''; thumbList.length=0; log('已清空佇列');});

</script>
</body>
</html>
